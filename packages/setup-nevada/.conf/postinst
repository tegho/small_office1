#!/bin/sh

set -e
case "$1" in
    configure)
        systemctl daemon-reload

        find /etc/ddns-afraid-org.d -type f -exec chmod 640 '{}' \;
        find /etc/ddns-afraid-org.d -type d -exec chmod 750 '{}' \;

        # bind9 DNS
        chown -R bind:bind /var/lib/bind/zones
        dpkg-divert --package $package_name --divert /etc/bind/named.conf-original --rename --add /etc/bind/named.conf
        [ ! -e /etc/bind/named.conf -o -L /etc/bind/named.conf ] && ln -sf /etc/bind/named.conf-$package_name /etc/bind/named.conf
        /etc/bind/keys/generate-key.sh
#        deb-systemd-invoke status bind9 >/dev/null 2>&1 && deb-systemd-invoke restart bind9
        deb-systemd-invoke restart bind9

        # nginx
        ln -fs /etc/nginx/sites-available/stat /etc/nginx/sites-enabled/stat
        deb-systemd-invoke restart nginx

        # CRL updater
        deb-systemd-invoke enable montana-crl.service && \
          deb-systemd-invoke enable montana-crl.timer && \
          deb-systemd-invoke start montana-crl.service && \
          deb-systemd-invoke start montana-crl.timer

        # iptables
        deb-systemd-invoke enable iptables.service && \
          deb-systemd-invoke restart iptables.service

        # sysctl
        deb-systemd-invoke restart procps.service

        deb-systemd-invoke enable openvpn-server@vpn1
#          deb-systemd-invoke restart openvpn-server@vpn1

        deb-systemd-invoke enable strongswan
#          deb-systemd-invoke restart strongswan

        # deb-systemd-invoke restart networking
        ifup int

        echo "==============================================="
        echo "Now import server keys from PKI and start VPNs:"
        echo "  systemctl restart openvpn-server@vpn1"
        echo "  systemctl restart strongswan"
        echo "==============================================="


    ;;
    abort-upgrade|abort-remove|abort-deconfigure)
    ;;
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac
exit 0
